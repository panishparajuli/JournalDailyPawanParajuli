@page "/calendar"
@using JournalDaily.ViewModels
@using JournalDaily.Services
@inject JournalService JournalService
@implements IAsyncDisposable

<div class="calendar-container">
    <div class="calendar-header">
        <button class="nav-button" @onclick="() => ViewModel?.PreviousMonthCommand.Execute(null)">
            <span class="arrow-icon">‚Üê</span>
        </button>
        
        <div class="month-year-section">
            <h2 class="month-year">
                @CurrentMonth.ToString("MMMM yyyy")
            </h2>
            <button class="today-button" @onclick="() => ViewModel?.TodayCommand.Execute(null)">
                Today
            </button>
        </div>

        <button class="nav-button" @onclick="() => ViewModel?.NextMonthCommand.Execute(null)">
            <span class="arrow-icon">‚Üí</span>
        </button>
    </div>

    @if (ViewModel?.IsLoading ?? false)
    {
        <div class="loading-spinner">
            <p>Loading calendar...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(ViewModel?.ErrorMessage))
    {
        <div class="error-message">
            <p>‚ö†Ô∏è @ViewModel.ErrorMessage</p>
        </div>
    }
    else
    {
        <div class="calendar-grid-container">
            <div class="weekday-header">
                <div class="weekday">Sun</div>
                <div class="weekday">Mon</div>
                <div class="weekday">Tue</div>
                <div class="weekday">Wed</div>
                <div class="weekday">Thu</div>
                <div class="weekday">Fri</div>
                <div class="weekday">Sat</div>
            </div>

            <div class="calendar-grid">
                @foreach (var day in ViewModel?.CalendarDays ?? new System.Collections.ObjectModel.ObservableCollection<CalendarDay>())
                {
                    var isSelected = ViewModel?.SelectedDate?.Date == day.Date.Date;
                    var classes = $"calendar-day {(day.IsCurrentMonth ? "" : "other-month")} {(day.HasEntry ? "has-entry" : "")} {(isSelected ? "selected" : "")} {(day.Date.Date == DateTime.Today ? "today" : "")}";

                    <div class="@classes" @onclick="() => SelectDate(day.Date)">
                        <div class="day-number">@day.Date.Day</div>
                        @if (day.HasEntry)
                        {
                            <div class="entry-indicator">üìù</div>
                        }
                    </div>
                }
            </div>
        </div>

        @if (ViewModel?.SelectedEntry != null)
        {
            <div class="selected-entry-panel">
                <div class="entry-header">
                    <h3>@(string.IsNullOrEmpty(ViewModel.SelectedEntry.Title) ? "Untitled Entry" : ViewModel.SelectedEntry.Title)</h3>
                    <span class="entry-date">@ViewModel.SelectedEntry.EntryDate.ToString("dddd, MMMM d, yyyy")</span>
                </div>

                @if (ViewModel.SelectedEntry.EntryMoods.Any())
                {
                    <div class="moods-section">
                        <strong>Moods:</strong>
                        <div class="moods-list">
                            @foreach (var mood in ViewModel.SelectedEntry.EntryMoods)
                            {
                                <span class="mood-badge @(mood.IsPrimary ? "primary" : "")">
                                    @mood.Mood?.Name
                                </span>
                            }
                        </div>
                    </div>
                }

                @if (ViewModel.SelectedEntry.EntryTags.Any())
                {
                    <div class="tags-section">
                        <strong>Tags:</strong>
                        <div class="tags-list">
                            @foreach (var tag in ViewModel.SelectedEntry.EntryTags)
                            {
                                <span class="tag-badge">#@tag.Tag?.Name</span>
                            }
                        </div>
                    </div>
                }

                <div class="content-section">
                    <p>@ViewModel.SelectedEntry.Content</p>
                </div>

                <div class="entry-footer">
                    <small>Updated: @ViewModel.SelectedEntry.UpdatedAt.ToString("g")</small>
                </div>
            </div>
        }
        else if (ViewModel?.SelectedDate.HasValue ?? false)
        {
            <div class="selected-entry-panel empty">
                <p>No entry for @ViewModel.SelectedDate.Value.ToString("dddd, MMMM d, yyyy")</p>
            </div>
        }
    }
</div>

@code {
    private CalendarViewModel? ViewModel { get; set; }

    private DateTime CurrentMonth => ViewModel?.CurrentMonth ?? DateTime.Today;

    protected override async Task OnInitializedAsync()
    {
        ViewModel = new CalendarViewModel(JournalService);
        await ViewModel.InitializeAsync();
    }

    private void SelectDate(DateTime date)
    {
        ViewModel?.SelectDateCommand.Execute(date);
        StateHasChanged();
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        // Cleanup if needed
        await ValueTask.CompletedTask;
    }
}
