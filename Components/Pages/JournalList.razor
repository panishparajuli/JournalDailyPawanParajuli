@page "/entries"
@using JournalDaily.ViewModels
@using JournalDaily.Services
@inject JournalService JournalService
@implements IAsyncDisposable

<div class="journal-list-container">
    <div class="journal-header">
        <h2>Journal Entries</h2>
        <button class="refresh-button" @onclick="() => ViewModel?.RefreshCommand.Execute(null)">
            üîÑ Refresh
        </button>
    </div>

    @if (ViewModel?.IsLoading ?? false)
    {
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Loading entries...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(ViewModel?.ErrorMessage))
    {
        <div class="error-state">
            <p>‚ö†Ô∏è @ViewModel.ErrorMessage</p>
            <button class="btn-retry" @onclick="() => ViewModel?.RefreshCommand.Execute(null)">Retry</button>
        </div>
    }
    else if (!ViewModel?.CurrentPageEntries.Any() ?? false)
    {
        <div class="empty-state">
            <div class="empty-icon">üìì</div>
            <h3>No Entries Yet</h3>
            <p>Start journaling to see your entries here.</p>
        </div>
    }
    else
    {
        <div class="entries-list">
            @foreach (var entry in ViewModel?.CurrentPageEntries ?? new System.Collections.ObjectModel.ObservableCollection<JournalEntry>())
            {
                <div class="entry-card">
                    <div class="entry-card-header">
                        <h3 class="entry-title">@(string.IsNullOrEmpty(entry.Title) ? "Untitled Entry" : entry.Title)</h3>
                        <span class="entry-date">@entry.EntryDate.ToString("dddd, MMMM d, yyyy")</span>
                    </div>

                    <div class="entry-meta">
                        @if (entry.EntryMoods.Any())
                        {
                            <div class="mood-badges">
                                @foreach (var mood in entry.EntryMoods.OrderByDescending(m => m.IsPrimary))
                                {
                                    <span class="mood-badge @(mood.IsPrimary ? "primary" : "")">
                                        @mood.Mood?.Name
                                    </span>
                                }
                            </div>
                        }

                        @if (entry.EntryTags.Any())
                        {
                            <div class="tag-badges">
                                @foreach (var tag in entry.EntryTags.Take(3))
                                {
                                    <span class="tag-badge">#@tag.Tag?.Name</span>
                                }
                                @if (entry.EntryTags.Count > 3)
                                {
                                    <span class="tag-badge">+@(entry.EntryTags.Count - 3) more</span>
                                }
                            </div>
                        }
                    </div>

                    <div class="entry-content">
                        @{
                            var content = entry.Content ?? string.Empty;
                            var preview = content.Length > 200 ? content.Substring(0, 200) + "..." : content;
                        }
                        <p>@preview</p>
                    </div>

                    <div class="entry-footer">
                        <small class="updated-time">Updated: @entry.UpdatedAt.ToString("g")</small>
                    </div>
                </div>
            }
        </div>

        <div class="pagination-container">
            <div class="pagination-info">
                <p>@ViewModel?.PageInfo</p>
            </div>

            <div class="pagination-controls">
                <button class="nav-button" 
                        @onclick="() => ViewModel?.PreviousPageCommand.Execute(null)" 
                        disabled="@(!(ViewModel?.HasPreviousPage ?? false))">
                    ‚Üê Previous
                </button>

                <div class="page-indicator">
                    Page @((ViewModel?.CurrentPageIndex ?? 0) + 1) of @(ViewModel?.TotalPages ?? 0)
                </div>

                <button class="nav-button" 
                        @onclick="() => ViewModel?.NextPageCommand.Execute(null)" 
                        disabled="@(!(ViewModel?.HasNextPage ?? false))">
                    Next ‚Üí
                </button>
            </div>
        </div>
    }
</div>

@code {
    private JournalListViewModel? ViewModel { get; set; }

    protected override async Task OnInitializedAsync()
    {
        ViewModel = new JournalListViewModel(JournalService);
        await ViewModel.InitializeAsync();
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        await ValueTask.CompletedTask;
    }
}
